<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Ronda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        darkprimary: '#1F2937', // Gray 800
                        darksecondary: '#374151', // Gray 700
                        darkaccent: '#6EE7B7', // Emerald 300
                        darktext: '#F9FAFB', // Gray 50
                        darkplaceholder: '#9CA3AF' // Gray 400
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Gray 900 */
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div class="bg-darkprimary rounded-2xl shadow-xl p-6 md:p-10 w-full max-w-2xl text-darktext border border-darksecondary">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-darkaccent mb-6">
            ABSENSI RONDA BLOK H TANJUNG RESIDENCE
        </h1>
        
        <!-- Form Absensi -->
        <div id="attendance-form-container">
            <!-- Form ini akan diisi secara dinamis oleh JavaScript -->
        </div>

        <!-- Bagian Rekap -->
        <div id="recap-container" class="hidden">
            <h2 class="text-2xl font-semibold text-darkaccent mb-4 text-center">Rekap Absensi</h2>
            <div class="overflow-x-auto rounded-lg shadow-sm border border-darksecondary">
                <table id="recap-table" class="min-w-full bg-darksecondary divide-y divide-gray-600">
                    <thead class="bg-darkprimary">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Tanggal</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Jadwal Ronda</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Petugas Absen</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Petugas Ronda</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Keterangan</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-darkaccent uppercase tracking-wider">Hasil Prelek</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-600">
                        <!-- Data akan diisi di sini -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-6">
                <button id="back-to-form-btn" class="bg-darkaccent text-darkprimary font-medium py-2 px-6 rounded-full shadow-lg hover:bg-emerald-400 transition-colors duration-200">
                    Kembali ke Form
                </button>
            </div>
        </div>

        <!-- Tombol Rekap Absensi dipindahkan ke bawah dan selalu terlihat -->
        <div class="mt-8 flex justify-center">
            <button id="recap-btn" class="bg-darksecondary text-darktext font-medium py-2 px-6 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200 border border-gray-600">
                Rekap Absensi
            </button>
        </div>
    </div>

    <!-- Modal untuk pesan -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4">
        <div class="bg-darkprimary rounded-lg shadow-xl p-6 max-w-sm w-full text-center border border-darksecondary">
            <p id="modal-text" class="text-lg font-medium text-darktext"></p>
            <button id="close-modal-btn" class="mt-4 bg-darkaccent text-darkprimary py-2 px-6 rounded-full hover:bg-emerald-400 transition-colors duration-200">
                Tutup
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formContainer = document.getElementById('attendance-form-container');
            const recapContainer = document.getElementById('recap-container');
            const recapBtn = document.getElementById('recap-btn');
            const backToFormBtn = document.getElementById('back-to-form-btn');
            const messageModal = document.getElementById('message-modal');
            const modalText = document.getElementById('modal-text');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            // Jadwal ronda dan daftar petugas
            const schedule = [
                'Minggu Malam Senin',  // Sunday (0)
                'Senin Malam Selasa',  // Monday (1)
                'Selasa Malam Rabu',   // Tuesday (2)
                'Rabu Malam Kamis',    // Wednesday (3)
                'Kamis Malam Jumat',   // Thursday (4)
                'Jumat Malam Sabtu',   // Friday (5)
                'Sabtu Malam Minggu'   // Saturday (6)
            ];

            const patrolMembers = {
                'Senin Malam Selasa': ['Bp Aris H01', 'Bp Asep H03', 'Bp Iyeng H04', 'Bp Yayan', 'Bp Erik'],
                'Selasa Malam Rabu': ['Bp Ma\'ruf', 'Bp Sunara', 'Bp Eka'],
                // Jadwal 'Rabu Malam Kamis' telah dihapus
                'Kamis Malam Jumat': ['Bp Didin', 'Bp Hamzah', 'Bp Amrin', 'Bp Aden', 'Bp Nanda'],
                'Jumat Malam Sabtu': ['Bp Ujang Guru', 'Bp Wawan', 'Bp Riyan', 'Bp Asep H62', 'Bp Irwan', 'Bp Carkaya', 'Bp Andre'],
                'Sabtu Malam Minggu': ['Bp Imam Kurtubi', 'Bp Ayo', 'Bp Ajo', 'Bp Rizki'],
                'Minggu Malam Senin': ['Bp Haji Udin', 'Bp Imam H47', 'Bp Ikhsan', 'Bp Rastam']
            };

            // Fungsi untuk menampilkan modal pesan
            const showMessageModal = (message) => {
                modalText.textContent = message;
                messageModal.classList.remove('hidden');
                messageModal.classList.add('flex');
            };

            // Fungsi untuk menyembunyikan modal pesan
            const hideMessageModal = () => {
                messageModal.classList.remove('flex');
                messageModal.classList.add('hidden');
            };

            // Menutup modal saat tombol 'Tutup' ditekan
            closeModalBtn.addEventListener('click', hideMessageModal);

            // Fungsi untuk merender form absensi
            const renderForm = () => {
                const today = new Date();
                let dayIndex = today.getDay(); // 0 = Minggu, 1 = Senin, dst.
                
                // Jika hari ini Rabu (indeks 3), tampilkan jadwal hari sebelumnya (Selasa Malam Rabu)
                if (dayIndex === 3) { // Wednesday
                    dayIndex = 2; // Tuesday
                }

                const patrolDay = schedule[dayIndex];
                const patrolDate = today.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                // Mendapatkan daftar nama petugas untuk hari ini
                const currentPatrolMembers = patrolMembers[patrolDay] || [];
                
                // Cek apakah absensi hari ini sudah diisi
                const records = JSON.parse(localStorage.getItem('rondaRecords')) || [];
                const isSubmittedToday = records.some(record => record.date === today.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }));

                // Jika tidak ada jadwal atau absensi sudah diisi, tampilkan pesan
                if (currentPatrolMembers.length === 0) {
                    formContainer.innerHTML = `
                        <p class="text-center text-darktext">Tidak ada jadwal ronda yang terdaftar untuk hari ini.</p>
                    `;
                    return;
                }

                if (isSubmittedToday) {
                    formContainer.innerHTML = `
                        <p class="text-center text-darkaccent font-semibold text-lg mb-4">Absensi untuk hari ini sudah diisi.</p>
                        <p class="text-center text-darktext mb-6">Anda dapat melihat rekap absensi dengan menekan tombol di bawah.</p>
                    `;
                    return;
                }
                
                // Membuat daftar petugas dengan radio button untuk setiap orang
                const membersListHTML = currentPatrolMembers.map(member => {
                    const memberId = member.replace(/\s/g, '-');
                    return `
                        <div class="bg-darksecondary p-4 rounded-md border border-gray-600">
                            <h3 class="text-lg font-medium text-darktext mb-2">${member}</h3>
                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center">
                                    <input type="radio" id="hadir-${memberId}" name="status-${memberId}" value="Hadir" checked class="h-4 w-4 text-darkaccent focus:ring-darkaccent border-gray-600">
                                    <label for="hadir-${memberId}" class="ml-2 text-sm text-darktext">Hadir</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="alpa-${memberId}" name="status-${memberId}" value="Alpa" class="h-4 w-4 text-darkaccent focus:ring-darkaccent border-gray-600">
                                    <label for="alpa-${memberId}" class="ml-2 text-sm text-darktext">Alpa</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="ijin-${memberId}" name="status-${memberId}" value="Ijin" class="h-4 w-4 text-darkaccent focus:ring-darkaccent border-gray-600">
                                    <label for="ijin-${memberId}" class="ml-2 text-sm text-darktext">Ijin</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="sakit-${memberId}" name="status-${memberId}" value="Sakit" class="h-4 w-4 text-darkaccent focus:ring-darkaccent border-gray-600">
                                    <label for="sakit-${memberId}" class="ml-2 text-sm text-darktext">Sakit</label>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                const formHTML = `
                    <form id="attendance-form" class="space-y-6">
                        <!-- Informasi Hari dan Tanggal di dalam form -->
                        <div class="text-center text-darktext mb-4">
                            <p class="font-semibold">${patrolDay}, ${patrolDate}</p>
                        </div>
                        
                        <div>
                            <label for="petugasAbsen" class="block text-sm font-medium text-darktext">Petugas Absen</label>
                            <input type="text" id="petugasAbsen" name="petugasAbsen" class="mt-1 block w-full px-3 py-2 bg-darksecondary border border-gray-600 rounded-md shadow-sm focus:ring-darkaccent focus:border-darkaccent text-darktext placeholder-darkplaceholder" placeholder="Nama Lengkap" required>
                        </div>

                        <div class="space-y-4">
                           ${membersListHTML}
                        </div>

                        <div>
                            <label for="notes" class="block text-sm font-medium text-darktext">Keterangan / Petugas Pengganti</label>
                            <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-darksecondary border border-gray-600 rounded-md shadow-sm focus:ring-darkaccent focus:border-darkaccent text-darktext placeholder-darkplaceholder" placeholder="Masukkan keterangan..."></textarea>
                        </div>
                        <div>
                            <label for="prelek" class="block text-sm font-medium text-darktext">Hasil Prelek</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-darkplaceholder">Rp</span>
                                </div>
                                <input type="text" id="prelek" name="prelek" class="block w-full pl-10 pr-3 py-2 bg-darksecondary border border-gray-600 rounded-md focus:ring-darkaccent focus:border-darkaccent text-darktext placeholder-darkplaceholder" placeholder="0">
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <button type="submit" class="w-full md:w-auto bg-darkaccent text-darkprimary font-medium py-3 px-8 rounded-full shadow-lg hover:bg-emerald-400 transition-colors duration-200">
                                Simpan Absensi
                            </button>
                        </div>
                    </form>
                `;
                formContainer.innerHTML = formHTML;

                const form = document.getElementById('attendance-form');
                const prelekInput = document.getElementById('prelek');
                
                // Fungsi untuk memformat input Rupiah
                prelekInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value) {
                        e.target.value = new Intl.NumberFormat('id-ID').format(value);
                    }
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const petugasAbsen = document.getElementById('petugasAbsen').value;
                    const attendanceList = [];
                    let isStatusMissing = false;

                    currentPatrolMembers.forEach(member => {
                        const memberId = member.replace(/\s/g, '-');
                        const statusElement = form.querySelector(`input[name="status-${memberId}"]:checked`);
                        
                        // Validasi: pastikan status kehadiran dipilih untuk setiap petugas
                        if (!statusElement) {
                            isStatusMissing = true;
                        }

                        attendanceList.push({
                            petugas: member,
                            status: statusElement ? statusElement.value : 'Tidak Diisi'
                        });
                    });

                    // Validasi: pastikan field Petugas Absen tidak kosong dan status kehadiran terisi
                    if (isStatusMissing) {
                        showMessageModal('Silakan isi status kehadiran untuk semua petugas.');
                        return;
                    }

                    const notes = document.getElementById('notes').value;
                    const prelek = prelekInput.value.replace(/[^0-9]/g, '');

                    const newRecord = {
                        petugasAbsen: petugasAbsen, // Menyimpan nama petugas absen
                        date: today.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }),
                        patrolDay: patrolDay,
                        attendance: attendanceList,
                        notes: notes,
                        prelek: prelek
                    };

                    const records = JSON.parse(localStorage.getItem('rondaRecords')) || [];
                    records.push(newRecord);
                    localStorage.setItem('rondaRecords', JSON.stringify(records));

                    form.reset();
                    prelekInput.value = '';

                    // Set radio button pertama (Hadir) sebagai default setelah reset
                    currentPatrolMembers.forEach(member => {
                        const memberId = member.replace(/\s/g, '-');
                        const defaultRadio = document.getElementById(`hadir-${memberId}`);
                        if (defaultRadio) {
                            defaultRadio.checked = true;
                        }
                    });

                    showMessageModal('Absensi berhasil disimpan!');
                    renderForm(); // Render ulang form untuk menampilkan pesan "sudah diisi"
                });
            };

            // Fungsi untuk merender rekap absensi
            const renderRecap = () => {
                const records = JSON.parse(localStorage.getItem('rondaRecords')) || [];
                const recapTableBody = document.querySelector('#recap-table tbody');
                recapTableBody.innerHTML = '';
                if (records.length === 0) {
                    recapTableBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-darkplaceholder">Belum ada data absensi.</td></tr>`;
                } else {
                    records.forEach(record => {
                        record.attendance.forEach((member, index) => {
                            const row = document.createElement('tr');
                            if (index === 0) {
                                // Tampilkan data lengkap hanya untuk baris pertama
                                row.innerHTML = `
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${record.date}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${record.patrolDay}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${record.petugasAbsen}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${member.petugas}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${member.status}</td>
                                    <td class="px-4 py-3 text-sm text-darktext">${record.notes || '-'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">Rp${new Intl.NumberFormat('id-ID').format(record.prelek)}</td>
                                `;
                            } else {
                                // Untuk baris berikutnya, hanya tampilkan nama dan status
                                row.innerHTML = `
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext"></td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext"></td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext"></td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${member.petugas}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext">${member.status}</td>
                                    <td class="px-4 py-3 text-sm text-darktext"></td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-darktext"></td>
                                `;
                            }
                            recapTableBody.appendChild(row);
                        });
                    });
                }
            };

            // Pasang event listeners secara global dan hanya sekali
            recapBtn.addEventListener('click', () => {
                formContainer.classList.add('hidden');
                recapContainer.classList.remove('hidden');
                renderRecap();
            });

            backToFormBtn.addEventListener('click', () => {
                recapContainer.classList.add('hidden');
                formContainer.classList.remove('hidden');
                renderForm();
            });
            
            // Inisialisasi: render form saat halaman dimuat
            renderForm();
        });
    </script>

</body>
</html>
